<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challan Generator - M/S Balaji Beverage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Custom styles for better visual separation and aesthetics */
        body {
            /* NEW BACKGROUND IMAGE STYLES */
            background-color: #e8f5e9; /* Fallback color (Light Green) */
            background-image: url('https://cdn.pixabay.com/photo/2017/08/29/05/53/tea-garden-2692217_960_720.jpg');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed; /* Keeps the background static when scrolling */
        }
        .container {
            max-width: 960px;
            margin-top: 20px;
            margin-bottom: 20px;
            /* Semi-transparent white background for readability */
            background-color: rgba(255, 255, 255, 0.95);
        }
        h1, h2 { color: #2e8b57; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 20px; }
        .calculation-box {
            background-color: #e6f7ff;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .calculation-box p { margin: 0; font-size: 1.2em; font-weight: bold; color: #006699; }
        /* NEW STYLE: Manual Summary Box */
        .manual-summary-box {
            border: 1px dashed #006699;
            padding: 10px;
            border-radius: 4px;
            background-color: #ffffff;
            margin-top: 15px;
            display: none; /* Hidden by default */
        }
        .manual-summary-box .row div {
            font-size: 1.1em;
        }
        .manual-summary-box .remaining-weight {
            font-weight: bold;
        }

        .grower-list-container {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .grower-table th { background-color: #e8f5e9; position: sticky; top: 0; z-index: 10; }
        .challan-output { border: 2px solid #2e8b57; padding: 20px; border-radius: 8px; background-color: #f9fffb; }
        /* Style for hidden manual input column */
        .manual-input-cell, .manual-input-header {
            transition: opacity 0.3s, max-width 0.3s;
            opacity: 0;
            max-width: 0;
            overflow: hidden;
            padding-left: 0;
            padding-right: 0;
            border-right: none;
            border-left: none;
            vertical-align: middle !important;
        }
        .manual-input-cell.active, .manual-input-header.active {
            opacity: 1;
            max-width: 150px; /* Adjust as needed */
            padding-left: 1rem;
            padding-right: 1rem;
        }
        .manual-input-cell input {
            max-width: 100px;
        }
        /* NEW STYLE: Ensure dropdown menu for search is positioned and scrollable */
        #agentDropdownMenu.dropdown-menu {
             max-height: 250px;
             overflow-y: auto;
             display: block; /* Override default Bootstrap hiding */
             position: absolute; /* Ensure it overlays correctly */
             z-index: 1000;
             visibility: hidden; /* Use visibility to manage the 'show' state */
             opacity: 0;
             transition: opacity 0.2s, visibility 0.2s;
        }
        #agentDropdownMenu.dropdown-menu.show {
             visibility: visible;
             opacity: 1;
        }
        .dropdown-item:active {
            background-color: #2e8b57;
        }
    </style>
</head>
<body>

    <div class="container p-4 shadow-sm rounded-3">
        <h1>Balaji Beverage (Green Leaf Challan Generator)</h1>

        <div class="row g-3">
            <div class="col-md-4">
                <label for="challanDate" class="form-label">Date: <span class="text-danger">*</span></label>
                <input type="date" id="challanDate" class="form-control" required>
            </div>
            <div class="col-md-8">
                <label for="agentSearchInput" class="form-label">Associated Lead Farmer (Agent): <span class="text-danger">*</span></label>
                <div class="dropdown">
                    <input type="text" id="agentSearchInput" class="form-control" placeholder="Search or Select Agent" autocomplete="off" required>
                    <input type="hidden" id="agentSelectValue" required> 
                    <div id="agentDropdownMenu" class="dropdown-menu w-100">
                        </div>
                </div>
                </div>
            <div class="col-md-4">
                <label for="vehicleNo" class="form-label">Vehicle No.:</label>
                <input type="text" id="vehicleNo" class="form-control" placeholder="E.g., AS-04-XX-1234">
            </div>
            <div class="col-md-4">
                <label for="grossWeight" class="form-label">Gross Weight (Kg): <span class="text-danger">*</span></label>
                <input type="number" id="grossWeight" class="form-control" min="0" step="1" required oninput="calculateWeight()">
            </div>
            <div class="col-md-4">
                <label for="tareWeight" class="form-label">Tare Weight (Kg): <span class="text-danger">*</span></label>
                <input type="number" id="tareWeight" class="form-control" min="0" step="1" required oninput="calculateWeight()">
            </div>

            <div class="col-md-6 row g-2">
                <label class="form-label mb-0">Deduction (Enter EITHER % OR Kg):</label>
                <div class="col-sm-6">
                    <div class="input-group">
                        <input type="number" id="deductionPercent" class="form-control" min="0" step="0.1" value="0" placeholder="In %" oninput="validateAndCalculate(this, 'deductionKg')">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="input-group">
                        <input type="number" id="deductionKg" class="form-control" min="0" step="1" placeholder="In Kg" oninput="validateAndCalculate(this, 'deductionPercent')">
                        <span class="input-group-text">Kg</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="calculation-box">
                    <p>Final Weight (Kg): <span id="finalWeightDisplay">0</span></p>
                    <span id="deductionApplied" class="text-muted" style="font-size: 0.9em;">(No Deduction Applied)</span>
                </div>
            </div>
        </div>

        <h2 class="mt-4">2. Grower Selection and Distribution</h2>

        <div class="mb-3">
            <label class="form-label d-block fw-bold">Distribution Mode: <span class="text-danger">*</span></label>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="distributionMode" id="modeProportional" value="proportional" checked onclick="toggleDistributionMode('proportional')">
                <label class="form-check-label" for="modeProportional">Automatic</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="distributionMode" id="modeManual" value="manual" onclick="toggleDistributionMode('manual')">
                <label class="form-check-label" for="modeManual">Manual</label>
            </div>
        </div>

        <div id="manualSummaryBox" class="manual-summary-box">
            <div class="row text-center">
                <div class="col-6 text-primary">
                    Distributed: <span id="manualDistributed" class="fw-bold">0</span> Kg
                </div>
                <div class="col-6">
                    Remaining: <span id="manualRemaining" class="remaining-weight text-danger">0</span> Kg
                </div>
            </div>
        </div>
        <div class="grower-list-container">
            <table class="table table-striped table-hover grower-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">Select</th>
                        <th style="width: 20%;">Supplier Code</th>
                        <th style="width: 30%;">Supplier Name</th>
                        <th style="width: 10%;">Land (Ha.)</th>
                        <th class="manual-input-header" id="manualInputHeader">Manual Weight (Kg)</th>
                        <th style="width: 20%;">Distributed Weight (Kg)</th>
                    </tr>
                </thead>
                <tbody id="growerTableBody">
                    <tr><td colspan="6" class="text-center">Search and Select an Agent to view growers.</td></tr>
                </tbody>
            </table>
        </div>

        <div class="text-center my-4">
            <button class="btn btn-success btn-lg" onclick="distributeWeight()">Distribute Final Weight</button>
        </div>

        <div id="challanOutput" class="challan-output" style="display: none;">
            <h2 class="text-center">Generated Challan: <span id="challanNumberDisplay"></span></h2>

            <div class="row mb-3">
                <div class="col-md-6"><p class="mb-1"><strong>Date:</strong> <span id="outDate"></span></p></div>
                <div class="col-md-6"><p class="mb-1"><strong>Agent:</strong> <span id="outAgent"></span></p></div>
                <div class="col-md-6"><p class="mb-1"><strong>Vehicle No.:</strong> <span id="outVehicleNo"></span></p></div>
                <div class="col-md-6"><p class="mb-1"><strong>Final Weight:</strong> <span id="outNetWeight"></span> Kg (<span id="outDeductionRate"></span>)</p></div>
            </div>

            <table class="table table-bordered table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Supplier Code</th>
                        <th>Supplier Name</th>
                        <th>Distributed Weight (Kg)</th>
                    </tr>
                </thead>
                <tbody id="challanDetailsBody">
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2" class="text-end fw-bold">TOTAL DISTRIBUTED WEIGHT:</td>
                        <td id="outTotalWeight" class="fw-bold"></td>
                    </tr>
                </tfoot>
            </table>

            <div class="d-flex justify-content-end gap-3 mt-3">
                <button class="btn btn-danger pdf-btn" onclick="downloadChallanPDF()">
                    ‚¨áÔ∏è Download Challan (PDF)
                </button>
                <button class="btn btn-secondary" onclick="downloadChallanTXT()">
                    üìù Download Challan (TXT)
                </button>
            </div>
            </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // --- GLOBAL DATA STORE FOR PDF ---
        let currentChallanData = {
            header: {},
            details: [],
            totalDistributed: 0
        };

        // --- DATA FROM CSV FILE (Hardcoded for client-side functionality) ---
        const RAW_GROWER_DATA = [
 {
  "code": "BB01",
  "name": "Mukta Musahari",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 9.33
 },
 {
  "code": "BB02",
  "name": "Anita Ramchiyari",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 1.53
 },
 {
  "code": "BB03",
  "name": "Ranjit Swrgiary",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 0.53
 },
 {
  "code": "BB04",
  "name": "Rupa Narzary",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 0.8
 },
 {
  "code": "BB05",
  "name": "Soojoy Basumatary",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 1.33
 },
 {
  "code": "BB06",
  "name": "Pungka Baglary",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 0.4
 },
 {
  "code": "BB07",
  "name": "Dhiren Basumatary",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 0.53
 },
 {
  "code": "BB08",
  "name": "Simon Basumatary",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 1.0
 },
 {
  "code": "BB09",
  "name": "Junali Basumatary",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 2.0
 },
 {
  "code": "BB10",
  "name": "JUIBAN SAIKIA",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 0.26
 },
 {
  "code": "BB11",
  "name": "PURANJOY BORAH",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 3.0
 },
 {
  "code": "BB12",
  "name": "NIRANJAN HAZARIKA",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 1.0
 },
 {
  "code": "BB13",
  "name": "GUNADHAR MILI",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 1.34
 },
 {
  "code": "BB14",
  "name": "SUBHRA ALCH",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 4.0
 },
 {
  "code": "BB15",
  "name": "Dilip Boro",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 1.0
 },
 {
  "code": "BB16",
  "name": "Nijora Boro",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 0.46
 },
 {
  "code": "BB17",
  "name": "Binay Narzary",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 0.53
 },
 {
  "code": "BB18",
  "name": "Suchil Boro",
  "agent": "Mukta Musahari(Tharaina Tea Garden)",
  "landHa": 0.4
 },
 {
  "code": "BB19",
  "name": "KAMALA PRASAD SARMAH",
  "agent": "Mukta Musahari(Tharaina Tea Garden)",
  "landHa": 0.4
 },
 {
  "code": "BB20",
  "name": "Talarem Tantabal",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 9.19
 },
 {
  "code": "BB21",
  "name": "JITU SAIKIA",
  "agent": "Mukta Musahari (Tharaina Tea Garden)",
  "landHa": 0.4
 },
 {
  "code": "BB22",
  "name": "MADHAB NATH",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 3.33
 },
 {
  "code": "BB23",
  "name": "GOPAL NATH",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.4
 },
 {
  "code": "BB24",
  "name": "RUHIT NATH",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.4
 },
 {
  "code": "BB25",
  "name": "DULAL KOCH",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.9
 },
 {
  "code": "BB26",
  "name": "RAMANI BHUYAN",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.31
 },
 {
  "code": "BB27",
  "name": "JAGAT NATH",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.26
 },
 {
  "code": "BB28",
  "name": "PRAMILA SAIKIA",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.13
 },
 {
  "code": "BB29",
  "name": "SON MONI BORAH",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 1.5
 },
 {
  "code": "BB30",
  "name": "JAYANTA HATIBARUAH",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 1.07
 },
 {
  "code": "BB31",
  "name": "JITEN MUSAHARI",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.26
 },
 {
  "code": "BB32",
  "name": "LAKHESWAR DAS",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.26
 },
 {
  "code": "BB33",
  "name": "PABITA SAIKIA",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.13
 },
 {
  "code": "BB34",
  "name": "HOMNATH NEWAR",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.66
 },
 {
  "code": "BB35",
  "name": "BOGIRAM BORA",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.66
 },
 {
  "code": "BB36",
  "name": "SIVALAL NEWAR",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 2.14
 },
 {
  "code": "BB37",
  "name": "KRISHNA PRASAD UPADHAYA",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.4
 },
 {
  "code": "BB38",
  "name": "KAMAL LIMBU",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.4
 },
 {
  "code": "BB39",
  "name": "MALIKA DUTTA",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 2.0
 },
 {
  "code": "BB40",
  "name": "RUBUL NATH",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.4
 },
 {
  "code": "BB41",
  "name": "BABUL BORAH",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.26
 },
 {
  "code": "BB42",
  "name": "KRISHNA NEWAR",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 1.06
 },
 {
  "code": "BB43",
  "name": "RUN MONI NATH",
  "agent": "MADHAB NATH (JOY SIDDHI)",
  "landHa": 0.53
 },
 {
  "code": "BB44",
  "name": "TAKNATH SARMA",
  "agent": "TAKNATH SARMA (PITA RUDRAMONI TG)",
  "landHa": 0.65
 },
 {
  "code": "BB45",
  "name": "KHAGEN CH. MEDHI",
  "agent": "KHAGEN CH. MEDHI (SHIVPUR TEA GARDEN)",
  "landHa": 6.67
 },
 {
  "code": "BB46",
  "name": "DAMBARU CHETRY",
  "agent": "DAMBARU CHETRY (MON TEA GARDEN)",
  "landHa": 6.67
 },
 {
  "code": "BB47",
  "name": "PREM BAHADUR CHETRY",
  "agent": "DAMBARU CHETRY (MON TEA GARDEN)",
  "landHa": 0.4
 },
 {
  "code": "BB48",
  "name": "UMA DEVI",
  "agent": "DAMBARU CHETRY (MON TEA GARDEN)",
  "landHa": 0.13
 },
 {
  "code": "BB49",
  "name": "GANGA MAYA CHETRY",
  "agent": "DAMBARU CHETRY (MON TEA GARDEN)",
  "landHa": 0.13
 },
 {
  "code": "BB50",
  "name": "MAYA DEVI",
  "agent": "DAMBARU CHETRY (MON TEA GARDEN)",
  "landHa": 0.13
 },
 {
  "code": "BB51",
  "name": "MANOJ SHARMA",
  "agent": "DAMBARU CHETRY (MON TEA GARDEN)",
  "landHa": 0.4
 },
 {
  "code": "BB52",
  "name": "MD NAJAMOL ANSARI",
  "agent": "DAMBARU CHETRY (MON TEA GARDEN)",
  "landHa": 0.27
 },
 {
  "code": "BB53",
  "name": "NEWANCHI TANTI",
  "agent": "DAMBARU CHETRY (MON TEA GARDEN)",
  "landHa": 0.27
 },
 {
  "code": "BB54",
  "name": "ROHIT CHETRY",
  "agent": "DAMBARU CHETRY (MON TEA GARDEN)",
  "landHa": 0.27
 },
 {
  "code": "BB55",
  "name": "PRAKASH CHETRY",
  "agent": "DAMBARU CHETRY (MON TEA GARDEN)",
  "landHa": 0.27
 },
 {
  "code": "BB56",
  "name": "NARESH GUWALA",
  "agent": "DAMBARU CHETRY (MON TEA GARDEN)",
  "landHa": 1.33
 },
 {
  "code": "BB57",
  "name": "KANU PAGAG",
  "agent": "DAMBARU CHETRY (MON TEA GARDEN)",
  "landHa": 0.4
 },
 {
  "code": "BB58",
  "name": "ARUN DAS",
  "agent": "DAMBARU CHETRY (MON TEA GARDEN)",
  "landHa": 0.13
 },
 {
  "code": "BB59",
  "name": "SANJEEV CHETRY",
  "agent": "DAMBARU CHETRY (MON TEA GARDEN)",
  "landHa": 0.13
 },
 {
  "code": "BB60",
  "name": "INDRA CHETRY",
  "agent": "DAMBARU CHETRY (MON TEA GARDEN)",
  "landHa": 0.53
 },
 {
  "code": "BB61",
  "name": "DURGESWAR BORAH",
  "agent": "DURGESWAR BORAH (S.S. TEA GARDEN)",
  "landHa": 6.67
 },
 {
  "code": "BB62",
  "name": "DILIP GOHAIN",
  "agent": "DILIP GOHAIN (SEUJI TEA)",
  "landHa": 0.4
 },
 {
  "code": "BB63",
  "name": "BIPLAB GOGOI",
  "agent": "DILIP GOHAIN (SEUJI TEA)",
  "landHa": 1.07
 },
 {
  "code": "BB64",
  "name": "LAKHESWAR SAIKIA",
  "agent": "DILIP GOHAIN (SEUJI TEA)",
  "landHa": 1.2
 },
 {
  "code": "BB65",
  "name": "BHOLA HAZARIKA",
  "agent": "DILIP GOHAIN (SEUJI TEA)",
  "landHa": 0.27
 },
 {
  "code": "BB66",
  "name": "JAMINI LAMA",
  "agent": "DILIP GOHAIN (SEUJI TEA)",
  "landHa": 1.03
 },
 {
  "code": "BB67",
  "name": "RATUL BORAH",
  "agent": "DILIP GOHAIN (SEUJI TEA)",
  "landHa": 1.3
 },
 {
  "code": "BB68",
  "name": "OM PRAKASH UPADHAYA",
  "agent": "DILIP GOHAIN (SEUJI TEA)",
  "landHa": 0.66
 },
 {
  "code": "BB69",
  "name": "MONOJ LUIITEL",
  "agent": "MONOJ LUITEL (KRISHNA TEA GARDEN)",
  "landHa": 1.34
 },
 {
  "code": "BB70",
  "name": "GIRIDHARRI ADHIKARI",
  "agent": "MONOJ LUITEL (KRISHNA TEA GARDEN)",
  "landHa": 0.53
 },
 {
  "code": "BB71",
  "name": "TILAK UPADHYA",
  "agent": "MONOJ LUITEL (KRISHNA TEA GARDEN)",
  "landHa": 1.93
 },
 {
  "code": "BB72",
  "name": "DILIP MECH",
  "agent": "DILIP MECH (DILIP TEA GARDEN)",
  "landHa": 9.06
 },
 {
  "code": "BB73",
  "name": "BABUL MOHALIA",
  "agent": "DILIP MECH (DILIP TEA GARDEN)",
  "landHa": 1.33
 },
 {
  "code": "BB74",
  "name": "NUMAL BASUMATARY",
  "agent": "DILIP MECH (DILIP TEA GARDEN)",
  "landHa": 0.26
 },
 {
  "code": "BB75",
  "name": "SURESH DARJI",
  "agent": "DILIP MECH (DILIP TEA GARDEN)",
  "landHa": 0.26
 },
 {
  "code": "BB76",
  "name": "DYUT DEORI",
  "agent": "DILIP MECH (DILIP TEA GARDEN)",
  "landHa": 0.67
 },
 {
  "code": "BB77",
  "name": "NAG MURAH",
  "agent": "DILIP MECH (DILIP TEA GARDEN)",
  "landHa": 1.02
 },
 {
  "code": "BB78",
  "name": "BINOD DAHAL",
  "agent": "DILIP MECH (DILIP TEA GARDEN)",
  "landHa": 0.95
 },
 {
  "code": "BB79",
  "name": "BHARAT BASNET",
  "agent": "DILIP MECH (DILIP TEA GARDEN)",
  "landHa": 1.5
 },
 {
  "code": "BB80",
  "name": "HARI BANDHARI",
  "agent": "DILIP MECH (DILIP TEA GARDEN)",
  "landHa": 1.07
 },
 {
  "code": "BB81",
  "name": "BALIMAYA PRADHAN",
  "agent": "DILIP MECH (DILIP TEA GARDEN)",
  "landHa": 1.07
 },
 {
  "code": "BB82",
  "name": "KIRAN BHANDARI",
  "agent": "DILIP MECH (DILIP TEA GARDEN)",
  "landHa": 1.07
 },
 {
  "code": "BB83",
  "name": "NANIM PAGAG",
  "agent": "DILIP MECH (DILIP TEA GARDEN)",
  "landHa": 1.82
 },
 {
  "code": "BB84",
  "name": "THAN BAHADUR RAI",
  "agent": "DILIP MECH (DILIP TEA GARDEN)",
  "landHa": 0.96
 },
 {
  "code": "BB85",
  "name": "GANESH SAHU",
  "agent": "GANESH SAHU (GANESH TEA GARDEN)",
  "landHa": 2.4
 },
 {
  "code": "BB86",
  "name": "SUMITRA SAHU",
  "agent": "GANESH SAHU (GANESH TEA GARDEN)",
  "landHa": 0.8
 },
 {
  "code": "BB87",
  "name": "JUNALI BRAHMA SHIL",
  "agent": "GANESH SAHU (GANESH TEA GARDEN)",
  "landHa": 1.5
 },
 {
  "code": "BB88",
  "name": "KANAI SAHU",
  "agent": "GANESH SAHU (GANESH TEA GARDEN)",
  "landHa": 1.35
 },
 {
  "code": "BB89",
  "name": "PRADIP CHOUDHURY",
  "agent": "GANESH SAHU (GANESH TEA GARDEN)",
  "landHa": 1.15
 },
 {
  "code": "BB90",
  "name": "KRISHNA CHOUDHURY",
  "agent": "GANESH SAHU (GANESH TEA GARDEN)",
  "landHa": 1.11
 },
 {
  "code": "BB91",
  "name": "MADHAB SHARMA",
  "agent": "MADHAV SHARMA(JUNA TG)",
  "landHa": 4.66
 },
 {
  "code": "BB92",
  "name": "SARAT NATH",
  "agent": "SARAT NATH",
  "landHa": 0.53
 },
 {
  "code": "BB93",
  "name": "BABUL BHUYAN",
  "agent": "SARAT NATH",
  "landHa": 1.0
 },
 {
  "code": "BB94",
  "name": "TUL TUL SAIKIA",
  "agent": "SARAT NATH",
  "landHa": 0.53
 },
 {
  "code": "BB95",
  "name": "CHARU KAMAL NEOG",
  "agent": "SARAT NATH",
  "landHa": 0.96
 },
 {
  "code": "BB96",
  "name": "DAYUT DEORI",
  "agent": "SARAT NATH",
  "landHa": 0.67
 },
 {
  "code": "BB97",
  "name": "PRANAB BORMUDOI",
  "agent": "PRANAB BORMUDOI (TAGAR TEA GARDEN)",
  "landHa": 9.28
 },
 {
  "code": "BB98",
  "name": "RANJIT KUNDU",
  "agent": "PRANAB BORMUDOI (TAGAR TEA GARDEN)",
  "landHa": 2.0
 },
 {
  "code": "BB99",
  "name": "DEBAJYOTI BORAH",
  "agent": "PRANAB BORMUDOI (TAGAR TEA GARDEN)",
  "landHa": 1.0
 },
 {
  "code": "BB100",
  "name": "BIDYADHAR DULAL",
  "agent": "PRANAB BORMUDOI (TAGAR TEA GARDEN)",
  "landHa": 2.69
 },
 {
  "code": "BB101",
  "name": "MRIGEN HAZARIKA",
  "agent": "PRANAB BORMUDOI (TAGAR TEA GARDEN)",
  "landHa": 1.86
 },
 {
  "code": "BB102",
  "name": "AMRIT PRAJAPATI",
  "agent": "AMRIT PRAJAPATI (AMRIT TEA GARDEN)",
  "landHa": 9.35
 },
 {
  "code": "BB103",
  "name": "NARAYAN SHARMA",
  "agent": "NARAYAN SHARMA (DUIBHONI)",
  "landHa": 6.5
 },
 {
  "code": "BB104",
  "name": "TAPAN SARMA",
  "agent": "TAPAN SARMA (MAA PREMA)",
  "landHa": 8.0
 },
 {
  "code": "BB105",
  "name": "CHURAMONI CHETRI",
  "agent": "CHURAMONI CHETRI (DAMBARU TEA GARDEN)",
  "landHa": 0.4
 },
 {
  "code": "BB106",
  "name": "MUKTINATH UPADHYAYA",
  "agent": "CHURAMONI CHETRI (DAMBARU TEA GARDEN)",
  "landHa": 3.03
 },
 {
  "code": "BB107",
  "name": "ARUN KUMAR CHETRY",
  "agent": "CHURAMONI CHETRI (DAMBARU TEA GARDEN)",
  "landHa": 0.53
 },
 {
  "code": "BB108",
  "name": "PANIDHAR UPADHYAYA",
  "agent": "CHURAMONI CHETRI (DAMBARU TEA GARDEN)",
  "landHa": 1.88
 },
 {
  "code": "BB109",
  "name": "AJOY SUNDI",
  "agent": "AJOY SUNDI (MA SANDHYA)",
  "landHa": 6.0
 },
 {
  "code": "BB110",
  "name": "UDDIN DAHAL",
  "agent": "AJOY SUNDI (MA SANDHYA)",
  "landHa": 0.8
 },
 {
  "code": "BB111",
  "name": "MUKUNDA KHANDAL",
  "agent": "AJOY SUNDI (MA SANDHYA)",
  "landHa": 0.67
 },
 {
  "code": "BB112",
  "name": "BHARAT KARKI",
  "agent": "AJOY SUNDI (MA SANDHYA)",
  "landHa": 1.02
 },
 {
  "code": "BB113",
  "name": "JOY BAHADUR KHANDAL",
  "agent": "AJOY SUNDI (MA SANDHYA)",
  "landHa": 5.0
 },
 {
  "code": "BB114",
  "name": "DHARANI CHINTE",
  "agent": "AJOY SUNDI (MA SANDHYA)",
  "landHa": 0.53
 },
 {
  "code": "BB115",
  "name": "SHIVALAL NEWAR",
  "agent": "AJOY SUNDI (MA SANDHYA)",
  "landHa": 2.14
 },
 {
  "code": "BB116",
  "name": "INDRA CHETRY",
  "agent": "AJOY SUNDI (MA SANDHYA)",
  "landHa": 0.77
 },
 {
  "code": "BB117",
  "name": "OM PRASHAD SHARMA",
  "agent": "AJOY SUNDI (MA SANDHYA)",
  "landHa": 0.9
 },
 {
  "code": "BB118",
  "name": "KRISHNA UPADHAYA",
  "agent": "AJOY SUNDI (MA SANDHYA)",
  "landHa": 0.4
 },
 {
  "code": "BB119",
  "name": "BHISMA SHARMA",
  "agent": "AJOY SUNDI (MA SANDHYA)",
  "landHa": 1.34
 },
 {
  "code": "BB120",
  "name": "GAMBHIR NARAH",
  "agent": "AJOY SUNDI (MA SANDHYA)",
  "landHa": 0.53
 },
 {
  "code": "BB121",
  "name": "SUNIL MILI",
  "agent": "AJOY SUNDI (MA SANDHYA)",
  "landHa": 0.53
 },
 {
  "code": "BB122",
  "name": "BHAWANI UPADHAYA",
  "agent": "AJOY SUNDI (MA SANDHYA)",
  "landHa": 0.53
 },
 {
  "code": "BB123",
  "name": "CHANDAN KOLKAMAR",
  "agent": "CHANDAN KOLKAMAR (B.P. TEA GARDEN)",
  "landHa": 1.0
 },
 {
  "code": "BB124",
  "name": "JOYPRAKASH SAHU",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 8.0
 },
 {
  "code": "BB125",
  "name": "SATYANATH NARAH",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 2.0
 },
 {
  "code": "BB126",
  "name": "ANIL PRADHAN",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 1.05
 },
 {
  "code": "BB127",
  "name": "SURAJ PRADHAN",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 1.84
 },
 {
  "code": "BB128",
  "name": "MANIK BORAH",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 2.02
 },
 {
  "code": "BB129",
  "name": "GOLAP BORAH",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 2.1
 },
 {
  "code": "BB130",
  "name": " CHIRANJIB P.SINGH KURMI",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 3.0
 },
 {
  "code": "BB131",
  "name": "BABULAL KURMI",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 0.51
 },
 {
  "code": "BB132",
  "name": "LILADHAR TAYE",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 1.33
 },
 {
  "code": "BB133",
  "name": "KRISHNA BHARALI",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 1.0
 },
 {
  "code": "BB134",
  "name": "LAKHI KANTO CHURAL",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 1.64
 },
 {
  "code": "BB135",
  "name": "DIPAK CHETRY",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 2.0
 },
 {
  "code": "BB136",
  "name": "NIKUL SAIKA",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 1.0
 },
 {
  "code": "BB137",
  "name": "IRSAD ALAM",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 1.34
 },
 {
  "code": "BB138",
  "name": "RAJESH CHETRY",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 0.53
 },
 {
  "code": "BB139",
  "name": "PAIRU KUMAR",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 1.0
 },
 {
  "code": "BB140",
  "name": "JEFAD KUDOR",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 1.0
 },
 {
  "code": "BB141",
  "name": "INDRA DEVI",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 0.3
 },
 {
  "code": "BB142",
  "name": "BALRAM SHARMA ",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 0.5
 },
 {
  "code": "BB143",
  "name": "CHABILAL SHARMA",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 0.67
 },
 {
  "code": "BB144",
  "name": "KULA SARMA",
  "agent": "JOYPRAKASH SAHU",
  "landHa": 0.8
 },
 {
  "code": "BB145",
  "name": "BIJU UPADHYAYA",
  "agent": "BIJU UPADHYAYA(BIJU TG)",
  "landHa": 9.0
 },
 {
  "code": "BB146",
  "name": "KUSHMAN CHETRI",
  "agent": "KUSHMAN CHETRI (BIJU TG)",
  "landHa": 5.3
 },
 {
  "code": "BB147",
  "name": "BIREN CHETRI",
  "agent": "KUSHMAN CHETRI (BIJU TG)",
  "landHa": 1.06
 },
 {
  "code": "BB148",
  "name": "MILON CHETRY",
  "agent": "KUSHMAN CHETRI (BIJU TG)",
  "landHa": 6.0
 },
 {
  "code": "BB149",
  "name": "BIKASH CHETRY",
  "agent": "KUSHMAN CHETRI (BIJU TG)",
  "landHa": 2.16
 },
 {
  "code": "BB150",
  "name": "NILADHWAJ BRAHMA",
  "agent": "NILADHWAJ BRAHMA (B.N. CARRIER)",
  "landHa": 1.16
 },
 {
  "code": "BB151",
  "name": "HARI KANTA NATH",
  "agent": "NILADHWAJ BRAHMA (B.N. CARRIER)",
  "landHa": 0.26
 },
 {
  "code": "BB152",
  "name": "TIPEN NATH",
  "agent": "NILADHWAJ BRAHMA (B.N. CARRIER)",
  "landHa": 0.73
 },
 {
  "code": "BB153",
  "name": "MON BAHADUR RAI",
  "agent": "NILADHWAJ BRAHMA (B.N. CARRIER)",
  "landHa": 1.0
 },
 {
  "code": "BB154",
  "name": "CHITRA DHAJ BORAH",
  "agent": "NILADHWAJ BRAHMA (B.N. CARRIER)",
  "landHa": 0.66
 },
 {
  "code": "BB155",
  "name": "BADAN BORA",
  "agent": "NILADHWAJ BRAHMA (B.N. CARRIER)",
  "landHa": 0.93
 },
 {
  "code": "BB156",
  "name": "Gabreal Basumatary",
  "agent": "NILADHWAJ BRAHMA (B.N. CARRIER)",
  "landHa": 0.66
 },
 {
  "code": "BB157",
  "name": "Hari Prasad Kurmi",
  "agent": "NILADHWAJ BRAHMA (B.N. CARRIER)",
  "landHa": 8.46
 },
 {
  "code": "BB158",
  "name": "Kiran Narjary",
  "agent": "NILADHWAJ BRAHMA (B.N. CARRIER)",
  "landHa": 0.39
 },
 {
  "code": "BB159",
  "name": "ALEKH TASSA",
  "agent": "NILADHWAJ BRAHMA (B.N. CARRIER)",
  "landHa": 1.0
 },
 {
  "code": "BB160",
  "name": "PAIRU KUMAR",
  "agent": "NILADHWAJ BRAHMA (B.N. CARRIER)",
  "landHa": 1.0
 },
 {
  "code": "BB161",
  "name": "JEFAD KUDOR",
  "agent": "NILADHWAJ BRAHMA (B.N. CARRIER)",
  "landHa": 1.0
 },
 {
  "code": "BB162",
  "name": "RATUL BORAH",
  "agent": "NILADHWAJ BRAHMA (B.N. CARRIER)",
  "landHa": 1.3
 },
 {
  "code": "BB163",
  "name": "MADHAB KUNDU",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 9.06
 },
 {
  "code": "BB164",
  "name": "MEGHNATH SHARMA",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 0.62
 },
 {
  "code": "BB165",
  "name": "AMRENDRA KUMAR",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 1.05
 },
 {
  "code": "BB166",
  "name": "TILAK SHARMA",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 0.94
 },
 {
  "code": "BB167",
  "name": "RINTU DUTTA",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 1.9
 },
 {
  "code": "BB168",
  "name": "UTTAM GUPTA",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 0.52
 },
 {
  "code": "BB169",
  "name": "LAKHAN ROY",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 2.0
 },
 {
  "code": "BB170",
  "name": "CHANDRALAL UPADHYAYA",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 1.52
 },
 {
  "code": "BB171",
  "name": "DWIJEN KURMI",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 0.4
 },
 {
  "code": "BB172",
  "name": "KULA SARMA",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 0.8
 },
 {
  "code": "BB174",
  "name": "BADAN SHARMA",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 0.3
 },
 {
  "code": "BB175",
  "name": "DILIP BORAH",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 1.34
 },
 {
  "code": "BB176",
  "name": "JOGEN BORAH",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 0.66
 },
 {
  "code": "BB178",
  "name": "HEMANTA BHATTARAI",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 5.0
 },
 {
  "code": "BB179",
  "name": "TANKAJ CHOWDHARY",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 2.0
 },
 {
  "code": "BB180",
  "name": "HIRAMOY CHOUDHURY",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 0.4
 },
 {
  "code": "BB181",
  "name": "MUKTINATH UPADHYAYA",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 0.5
 },
 {
  "code": "BB182",
  "name": "BHUBAN SHARMA",
  "agent": "MADHAB KUNDU (KUNDU TG)",
  "landHa": 0.8
 },
 {
  "code": "BB183",
  "name": "SURIYA SHARMA",
  "agent": "SURIYA SHARMA (MAA JANUKA)",
  "landHa": 4.0
 },
 {
  "code": "BB184",
  "name": "KAMAL SHARMA",
  "agent": "KAMAL SHARMA (MAA DIPA)",
  "landHa": 2.6
 },
 {
  "code": "BB185",
  "name": "DIPAK DAIMARI",
  "agent": "DIPAK DAIMARI (DIPAK TG)",
  "landHa": 7.7
 },
 {
  "code": "BB186",
  "name": "SANJAY MURA",
  "agent": "SANJAY MURA (JESSIKA TG)",
  "landHa": 2.67
 }
];

        /**
         * Generates the current date in YYYY-MM-DD format, which is required
         * for HTML date inputs.
         * @returns {string} Current date string.
         */
        function getCurrentDateFormatted() {
            const today = new Date();
            const yyyy = today.getFullYear();
            // getMonth() is 0-indexed, so add 1
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        /**
         * Handles the selection of an agent from the dropdown list.
         */
        function selectAgent(e, agent) {
            e.preventDefault(); // Prevent default link behavior

            const input = document.getElementById('agentSearchInput');
            const hiddenValue = document.getElementById('agentSelectValue');
            const dropdownMenu = document.getElementById('agentDropdownMenu');

            // 1. Update form fields
            input.value = agent; // Display the name in the input
            hiddenValue.value = agent; // Set the actual value
            dropdownMenu.classList.remove('show'); // Hide the list

            // 2. Trigger grower list filter
            filterGrowers(); 
        }

        /**
         * Filters the agent list in real-time based on the search input value.
         */
        function filterAgentList() {
            const input = document.getElementById('agentSearchInput');
            const filter = input.value.toUpperCase();
            const dropdownMenu = document.getElementById('agentDropdownMenu');
            const items = dropdownMenu.getElementsByTagName('a');
            
            let matchFound = false;
            let exactMatchFound = false;

            for (let i = 0; i < items.length; i++) {
                const txtValue = items[i].textContent || items[i].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    items[i].style.display = "";
                    matchFound = true;
                    if (txtValue.toUpperCase() === filter) {
                        exactMatchFound = true;
                    }
                } else {
                    items[i].style.display = "none";
                }
            }

            // Toggle Dropdown Visibility
            if (document.activeElement === input && matchFound) {
                 // Show dropdown only when input is focused and there are matches
                 dropdownMenu.classList.add('show');
            } else if (input.value.length > 0 && matchFound) {
                 // Keep visible while typing if matches exist
                 dropdownMenu.classList.add('show');
            } else {
                 dropdownMenu.classList.remove('show');
            }

            const hiddenValue = document.getElementById('agentSelectValue');

            // Clear growers list if input changes and doesn't match a *selected* value
            if (hiddenValue.value !== input.value) {
                hiddenValue.value = ''; // Clear confirmation if search term changes
                const tbody = document.getElementById('growerTableBody');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Search and Select an Agent to view growers.</td></tr>';
            }
        }


        // Populate Agent Dropdown on load
        document.addEventListener('DOMContentLoaded', () => {
            // Get unique agents
            let agents = [...new Set(RAW_GROWER_DATA.map(g => g.agent))];
            
            // Sort agents alphabetically
            agents.sort((a, b) => a.localeCompare(b));
            
            const dropdownMenu = document.getElementById('agentDropdownMenu');
            
            // Populate the new dropdown menu with list items
            agents.forEach(agent => {
                const item = document.createElement('a');
                item.classList.add('dropdown-item');
                item.href = '#';
                item.textContent = agent;
                item.dataset.value = agent; // Store the agent name as the value
                
                // Add click handler to select the agent and trigger grower filter
                item.onclick = (e) => selectAgent(e, agent);
                dropdownMenu.appendChild(item);
            });
            
            // Set default date to current date
            document.getElementById('challanDate').value = getCurrentDateFormatted();
            
            // Initial setup
            calculateWeight();
            toggleDistributionMode('proportional');

            // Setup Search Input Listeners
            document.getElementById('agentSearchInput').addEventListener('input', filterAgentList);
            // Hide the dropdown when blurring, but with a slight delay to allow click on an option
            document.getElementById('agentSearchInput').addEventListener('blur', () => {
                setTimeout(() => {
                    document.getElementById('agentDropdownMenu').classList.remove('show');
                }, 150);
            });
            document.getElementById('agentSearchInput').addEventListener('focus', () => {
                 // When focusing, if there's text, show filtered list. If empty, show all.
                 filterAgentList(); 
            });
        });

        // --- MUTUAL EXCLUSION VALIDATION ---

        function validateAndCalculate(currentInput, otherInputId) {
            const otherInput = document.getElementById(otherInputId);

            // Check if the current input has a value > 0
            if (parseFloat(currentInput.value) > 0) {
                // If current input has a value, disable and clear the other one
                if (otherInput.value !== '') {
                     otherInput.value = '';
                }
                otherInput.setAttribute('disabled', 'true');
            } else {
                // If current input is empty or 0, enable the other one
                otherInput.removeAttribute('disabled');
            }

            calculateWeight();
            // Recalculate manual summary if we are in manual mode (in case the final weight changed)
            if (document.getElementById('modeManual').checked) {
                updateManualDistributionSummary();
            }
        }

        // --- CALCULATIONS AND DISPLAY ---

        function calculateWeight() {
            const gross = parseFloat(document.getElementById('grossWeight').value) || 0;
            const tare = parseFloat(document.getElementById('tareWeight').value) || 0;
            const deductionPercent = parseFloat(document.getElementById('deductionPercent').value) || 0;
            const deductionKg = parseFloat(document.getElementById('deductionKg').value) || 0;

            let netWeight = gross - tare;

            if (netWeight <= 0) {
                document.getElementById('finalWeightDisplay').textContent = 0;
                document.getElementById('deductionApplied').textContent = `(Net Weight is 0 or less)`;
                return { finalWeight: 0, appliedDeduction: 0, isKgDeduction: false };
            }

            let finalWeight = netWeight;
            let appliedDeductionDisplay = `(No Deduction Applied)`;
            let appliedDeductionValue = 0;
            let isKgDeduction = false;

            // 1. Apply Percentage Deduction
            if (deductionPercent > 0) {
                finalWeight = netWeight * (1 - deductionPercent / 100);
                appliedDeductionDisplay = `(${deductionPercent.toFixed(1)}% Applied)`;
                appliedDeductionValue = deductionPercent;
                isKgDeduction = false;
            }
            // 2. Apply Absolute (Kg) Deduction
            else if (deductionKg > 0) {
                finalWeight = netWeight - deductionKg;
                appliedDeductionDisplay = `(${deductionKg.toLocaleString()} Kg Applied)`;
                appliedDeductionValue = deductionKg;
                isKgDeduction = true;

                if (finalWeight < 0) {
                    finalWeight = 0;
                }
            }

            const roundedFinalWeight = Math.round(finalWeight);

            document.getElementById('deductionApplied').textContent = appliedDeductionDisplay;
            document.getElementById('finalWeightDisplay').textContent = roundedFinalWeight.toLocaleString();

            return {
                finalWeight: roundedFinalWeight,
                appliedDeduction: appliedDeductionValue,
                isKgDeduction: isKgDeduction,
                deductionDisplay: appliedDeductionDisplay
            };
        }

        // --- MANUAL DISTRIBUTION REAL-TIME SUMMARY ---

        function updateManualDistributionSummary() {
            const weightResult = calculateWeight();
            const finalWeight = weightResult.finalWeight;

            // Only consider enabled inputs (i.e., selected growers in manual mode)
            const inputs = document.querySelectorAll('.grower-manual-input:not(:disabled)');
            let distributedTotal = 0;

            inputs.forEach(input => {
                distributedTotal += parseFloat(input.value) || 0;
            });

            const remainingWeight = finalWeight - distributedTotal;

            const distributedEl = document.getElementById('manualDistributed');
            const remainingEl = document.getElementById('manualRemaining');

            distributedEl.textContent = distributedTotal.toLocaleString();
            remainingEl.textContent = remainingWeight.toLocaleString();

            // Highlight remaining weight based on status
            if (remainingWeight === 0) {
                remainingEl.classList.remove('text-danger', 'text-warning');
                remainingEl.classList.add('text-success');
            } else if (remainingWeight > 0) {
                remainingEl.classList.remove('text-success', 'text-warning');
                remainingEl.classList.add('text-danger');
            } else { // remainingWeight < 0 (Over-distributed)
                remainingEl.classList.remove('text-success', 'text-danger');
                remainingEl.classList.add('text-warning');
            }
        }


        // --- GROWER FILTERING & UI TOGGLING ---

        let filteredGrowers = [];

        function toggleDistributionMode(mode) {
            const isManual = mode === 'manual';
            const manualCells = document.querySelectorAll('.manual-input-cell');
            const manualHeader = document.getElementById('manualInputHeader');
            const manualSummaryBox = document.getElementById('manualSummaryBox');

            // Toggle Manual Summary Box visibility
            manualSummaryBox.style.display = isManual ? 'block' : 'none';

            // Toggle header class
            if (isManual) {
                manualHeader.classList.add('active');
            } else {
                manualHeader.classList.remove('active');
            }

            // Toggle row input visibility/status
            manualCells.forEach(cell => {
                const input = cell.querySelector('input');
                const checkbox = cell.parentElement.querySelector('input[type="checkbox"]');

                if (isManual) {
                    cell.classList.add('active');
                    if (input) {
                        input.style.display = 'block';
                        // Only enable if the grower is checked
                        input.disabled = !checkbox.checked;
                    }
                } else {
                    cell.classList.remove('active');
                    if (input) {
                        input.style.display = 'none';
                        input.disabled = true;
                        input.value = 0; // Clear manual value when switching to auto mode
                    }
                }
            });

            // Always clear the distributed weight display when switching mode
            document.querySelectorAll('#growerTableBody td[id^="weight-"]').forEach(cell => cell.textContent = "0");


            if (isManual) {
                updateManualDistributionSummary(); // Initialize manual summary
            }
        }

        function toggleManualRow(checkbox) {
            const mode = document.querySelector('input[name="distributionMode"]:checked').value;
            const code = checkbox.dataset.code;
            const input = document.querySelector(`.grower-manual-input[data-code="${code}"]`);

            if (mode === 'manual' && input) {
                input.disabled = !checkbox.checked;
                if (!checkbox.checked) {
                    input.value = 0; // Clear value if unchecked
                }
                updateManualDistributionSummary(); // Update summary
            }
        }


        function filterGrowers() {
            // Read from the new hidden input field
            const selectedAgent = document.getElementById('agentSelectValue').value;
            const tbody = document.getElementById('growerTableBody');
            tbody.innerHTML = '';
            document.getElementById('challanOutput').style.display = 'none';

            if (!selectedAgent) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Search and Select an Agent to view growers.</td></tr>';
                return;
            }

            filteredGrowers = RAW_GROWER_DATA.filter(g => g.agent === selectedAgent).map(g => ({...g, weight: 0}));

            // --- START OF NEW SORTING LOGIC ---
            // Sort the filtered growers by land area (landHa) high to low
            filteredGrowers.sort((a, b) => b.landHa - a.landHa);
            // --- END OF NEW SORTING LOGIC ---

            filteredGrowers.forEach(grower => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="checkbox" data-code="${grower.code}" onchange="toggleManualRow(this)"></td>
                    <td>${grower.code}</td>
                    <td>${grower.name}</td>
                    <td>${grower.landHa.toFixed(3)}</td>
                    <td class="manual-input-cell" data-code="${grower.code}">
                        <input type="number" class="form-control form-control-sm grower-manual-input" data-code="${grower.code}" min="0" value="0" disabled style="display: none;" oninput="updateManualDistributionSummary()">
                    </td>
                    <td id="weight-${grower.code}">0</td>
                `;
            });
            // Re-apply the current mode styling after loading new growers
            const currentMode = document.querySelector('input[name="distributionMode"]:checked').value;
            toggleDistributionMode(currentMode);
        }

        // --- CORE DISTRIBUTION LOGIC HELPERS ---

        function calculateProportionalWeight(selectedGrowers, finalWeight) {
            const totalLandArea = selectedGrowers.reduce((sum, g) => sum + g.landHa, 0);

            if (totalLandArea === 0) {
                 alert("Selected growers must have a positive land holding area to distribute the weight proportionally.");
                 return null;
            }

            let remainingWeight = finalWeight;
            let growersWithRemainder = [];

            selectedGrowers.forEach(grower => {
                const share = (grower.landHa / totalLandArea) * finalWeight;
                grower.weight = Math.floor(share);
                remainingWeight -= grower.weight;
                growersWithRemainder.push({ grower, remainder: share - grower.weight });
            });

            // Distribute the remainder based on the highest decimals
            growersWithRemainder.sort((a, b) => b.remainder - a.remainder);

            for (let i = 0; i < remainingWeight; i++) {
                growersWithRemainder[i % growersWithRemainder.length].grower.weight += 1;
            }

            return selectedGrowers.filter(g => g.weight > 0);
        }

        function calculateManualWeight(selectedGrowers, finalWeight) {
            let manualTotal = 0;
            let distributedGrowers = [];

            // Get total from currently distributed growers (should match the real-time summary)
            const inputs = document.querySelectorAll('.grower-manual-input:not(:disabled)');

            inputs.forEach(input => {
                const code = input.dataset.code;
                const manualWeight = parseFloat(input.value) || 0;

                if (manualWeight > 0) {
                    const grower = selectedGrowers.find(g => g.code === code);
                    if (grower) {
                        grower.weight = manualWeight;
                        manualTotal += manualWeight;
                        distributedGrowers.push(grower);
                    }
                }
            });

            // Validation: Must match the net weight exactly
            if (manualTotal !== finalWeight) {
                alert(`Manual distribution error: The total distributed weight (${manualTotal.toLocaleString()} Kg) must exactly match the Final Distributed Weight (${finalWeight.toLocaleString()} Kg). Please adjust your manual entries.`);
                return null; // Signal failure
            }

            return distributedGrowers;
        }


        // --- CORE DISTRIBUTION LOGIC ---
        function distributeWeight() {
            const weightResult = calculateWeight();
            const finalWeight = weightResult.finalWeight;
            
            // Read from the new hidden input field
            const selectedAgent = document.getElementById('agentSelectValue').value;
            const searchInput = document.getElementById('agentSearchInput').value;

            // Mandatory Field Checks
            if (!document.getElementById('challanDate').value) {
                alert("Please select a Date.");
                return;
            }
            // Check if a valid agent has been selected (i.e., agentSelectValue is set)
            if (!selectedAgent || selectedAgent !== searchInput) {
                alert("Please search for and select a valid Agent from the dropdown list.");
                return;
            }
            // Vehicle No. is optional, removed mandatory check
            if (finalWeight <= 0) {
                alert("Please enter valid Gross and Tare weights resulting in a positive final weight.");
                return;
            }

            const checkboxes = document.querySelectorAll('#growerTableBody input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert("Please select at least one grower for distribution.");
                return;
            }

            // Get selected growers data
            const selectedGrowerCodes = Array.from(checkboxes).map(cb => cb.dataset.code);
            let selectedGrowers = filteredGrowers.filter(g => selectedGrowerCodes.includes(g.code));
            selectedGrowers.forEach(g => g.weight = 0); // Reset weights

            const mode = document.querySelector('input[name="distributionMode"]:checked').value;
            let finalDistribution = [];

            if (mode === 'proportional') {
                finalDistribution = calculateProportionalWeight(selectedGrowers, finalWeight);
            } else if (mode === 'manual') {
                finalDistribution = calculateManualWeight(selectedGrowers, finalWeight);
            }

            if (!finalDistribution) {
                // Calculation/validation failed (e.g., manual weight mismatch or zero land area)
                return;
            }

            updateDistributionUI(finalDistribution);
            generateChallan(finalDistribution, finalWeight, weightResult.deductionDisplay);
        }

        function updateDistributionUI(growers) {
            // Reset all table display weights first
            document.querySelectorAll('#growerTableBody td[id^="weight-"]').forEach(cell => cell.textContent = "0");

            // Update only the successfully distributed growers
            growers.forEach(grower => {
                const weightCell = document.getElementById(`weight-${grower.code}`);
                if (weightCell) {
                    weightCell.textContent = grower.weight.toLocaleString();
                }
            });
        }

        // --- CHALLAN GENERATION (UI) ---

        function generateChallan(distributedGrowers, finalWeight, deductionDisplay) {
            // Read from the new hidden input field
            const agent = document.getElementById('agentSelectValue').value;
            const date = document.getElementById('challanDate').value;
            // Vehicle No. might be empty now
            const vehicleNo = document.getElementById('vehicleNo').value || "N/A"; 
            const gross = parseFloat(document.getElementById('grossWeight').value) || 0;
            const tare = parseFloat(document.getElementById('tareWeight').value) || 0;
            const netWeightCalculated = gross - tare;

            const challanNumber = `${agent.substring(0, 3).toUpperCase()}-${date.replace(/-/g, '')}-${Math.floor(Math.random() * 900) + 100}`;

            // Populate Challan Header (UI)
            document.getElementById('challanNumberDisplay').textContent = challanNumber;
            document.getElementById('outDate').textContent = new Date(date).toLocaleDateString();
            document.getElementById('outAgent').textContent = agent;
            document.getElementById('outVehicleNo').textContent = vehicleNo;
            document.getElementById('outNetWeight').textContent = netWeightCalculated.toLocaleString();
            document.getElementById('outDeductionRate').textContent = deductionDisplay;


            // Populate Challan Details Table (UI)
            const detailsBody = document.getElementById('challanDetailsBody');
            detailsBody.innerHTML = '';
            let totalDistributed = 0;
            let detailsForPDF = [];

            distributedGrowers.forEach(grower => {
                if (grower.weight > 0) {
                    const row = detailsBody.insertRow();
                    row.innerHTML = `
                        <td>${grower.code}</td>
                        <td>${grower.name}</td>
                        <td>${grower.weight.toLocaleString()}</td>
                    `;
                    totalDistributed += grower.weight;

                    detailsForPDF.push({
                        code: grower.code,
                        name: grower.name,
                        weight: grower.weight
                    });
                }
            });

            document.getElementById('outTotalWeight').textContent = totalDistributed.toLocaleString() + " Kg";
            document.getElementById('challanOutput').style.display = 'block';

            // Store final data globally for the PDF download function
            currentChallanData.header = {
                challanNumber: challanNumber,
                date: date,
                agent: agent,
                vehicleNo: vehicleNo,
                grossWeight: gross,
                tareWeight: tare,
                netWeight: netWeightCalculated,
                deductionDisplay: deductionDisplay,
                finalWeight: finalWeight
            };
            currentChallanData.details = detailsForPDF;
            currentChallanData.totalDistributed = totalDistributed;
        }


        // --- PDF DOWNLOAD IMPLEMENTATION (2 COPIES) ---

        function drawSingleChallan(doc, data, yOffset, copyType) {
            let y = yOffset;
            const margin = 10;
            const rightMargin = 190;
            const xCenter = 105;

            // 1. Challan Header / Title
            doc.setFontSize(16);
            doc.text(`Green Leaf Challan (${copyType})`, xCenter, y, null, null, "center");
            y += 7;

            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text(`Challan No: ${data.header.challanNumber}`, margin, y);
            doc.text(`Date: ${new Date(data.header.date).toLocaleDateString()}`, rightMargin, y, null, null, "right");
            doc.setFont(undefined, 'normal');
            y += 5;

            doc.setFontSize(8);
            doc.text(`Agent: ${data.header.agent}`, margin, y);
            // Use "N/A" if field is empty
            const vehicleNoDisplay = data.header.vehicleNo && data.header.vehicleNo !== 'N/A' ? data.header.vehicleNo : 'N/A';
            doc.text(`Vehicle No: ${vehicleNoDisplay}`, rightMargin, y, null, null, "right");
            y += 4;

            doc.text(`Gross: ${data.header.grossWeight.toLocaleString()} Kg`, margin, y);
            doc.text(`Tare: ${data.header.tareWeight.toLocaleString()} Kg`, 70, y);

            // Use the stored deduction display string
            doc.text(`Deduction: ${data.header.deductionDisplay.replace(/[()]/g, '')}`, rightMargin, y, null, null, "right");
            y += 4;

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(`FINAL WEIGHT: ${data.header.finalWeight.toLocaleString()} Kg`, xCenter, y, null, null, "center");
            doc.setFont(undefined, 'normal');
            y += 7;

            // 2. Distribution Table Header
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            let xCode = margin;
            let xName = 45;
            let xWeight = 160;

            doc.text("Supplier Code", xCode, y);
            doc.text("Supplier Name", xName, y);
            doc.text("Weight (Kg)", xWeight, y);
            doc.line(margin, y + 1, rightMargin, y + 1);
            y += 5;

            // 3. Table Rows
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            data.details.forEach(grower => {
                doc.text(grower.code, xCode, y);
                doc.text(grower.name, xName, y);
                doc.text(grower.weight.toLocaleString(), xWeight, y);
                y += 4;
            });

            // 4. Footer Summary
            y += 2;
            doc.line(140, y, rightMargin, y);
            y += 4;
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text("TOTAL SUPPLIED LEAF QTY:", 110, y, null, null, "right");
            doc.text(data.totalDistributed.toLocaleString() + " Kg", xWeight, y);
            doc.setFont(undefined, 'normal');
            y += 10;

            // 5. Signature Section

            const sigLineLength = 50;
            const xSupplier = margin;
            const xReceiver = rightMargin - sigLineLength;

            doc.setFontSize(7);

            doc.line(xSupplier, y + 5, xSupplier + sigLineLength, y + 5);
            doc.text("Supplier Signature (Grower/Agent)", xSupplier + (sigLineLength / 2), y + 9, null, null, "center");

            doc.line(xReceiver, y + 5, xReceiver + sigLineLength, y + 5);
            doc.text("Receiver Signature (Factory/Company)", xReceiver + (sigLineLength / 2), y + 9, null, null, "center");

            return y + 12;
        }

        // MODIFIED PDF DOWNLOAD FUNCTION to center the tear line on A4
        function downloadChallanPDF() {
            if (!currentChallanData.header.challanNumber) {
                alert("Please generate the Challan first by clicking 'Distribute Final Weight'.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // A4 paper height is 297mm. The center point is 148.5mm.
            const A4_CENTER_Y = 148.5;

            // --- Draw the first copy (Top Half) - FACTORY COPY ---
            drawSingleChallan(doc, currentChallanData, 10, "Factory Copy");

            // --- Draw a dashed line separator EXACTLY in the middle (148.5mm) ---
            const tearLineY = A4_CENTER_Y;

            doc.setLineDash([2, 2], 0);
            doc.line(10, tearLineY, 200, tearLineY);
            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            // Position the text slightly above the line
            doc.text("----------------- Cut / Tear Here -----------------", 105, tearLineY - 2, null, null, "center");
            doc.setLineDash([], 0);

            // --- Draw the second copy (Bottom Half) - SUPPLIER COPY ---
            // Start the second copy 5mm below the center line (148.5 + 5 = 153.5mm)
            const secondCopyStartY = A4_CENTER_Y + 5;

            drawSingleChallan(doc, currentChallanData, secondCopyStartY, "Supplier Copy");

            doc.save(`Challan_${currentChallanData.header.challanNumber}_2Copies.pdf`);
        }

        // --- TXT FORMATTING HELPER ---
        function formatChallanToText(data, copyName) {
            const header = data.header;
            const details = data.details;
            const vehicleNoDisplay = header.vehicleNo && header.vehicleNo !== 'N/A' ? header.vehicleNo : 'N/A';

            let text = "";

            // --- Header ---
            text += "=================================================================\n";
            text += `             GREEN LEAF CHALLAN - ${copyName.toUpperCase()}\n`;
            text += "=================================================================\n";
            text += `Challan No: ${header.challanNumber || 'N/A'}\n`;
            text += `Date: ${new Date(header.date).toLocaleDateString() || 'N/A'}\n`;
            text += `Agent: ${header.agent || 'N/A'}\n`;
            text += `Vehicle No: ${vehicleNoDisplay}\n`;
            text += "-----------------------------------------------------------------\n";
            text += `Gross Weight (Kg): ${header.grossWeight.toLocaleString()}\n`;
            text += `Tare Weight (Kg): ${header.tareWeight.toLocaleString()}\n`;
            text += `Deduction Applied: ${header.deductionDisplay.replace(/[()]/g, '')}\n`;
            text += "-----------------------------------------------------------------\n";
            text += `NET LEAF WEIGHT: ${header.finalWeight.toLocaleString()} Kg\n`;
            text += "=================================================================\n\n";

            // --- Details Table ---
            text += "CODE          | SUPPLIER NAME               | WEIGHT (Kg)\n";
            text += "--------------|-----------------------------|--------------\n";

            // Use padding for alignment in plain text
            details.forEach(detail => {
                const code = String(detail.code).padEnd(13);
                const name = String(detail.name).padEnd(27).substring(0, 27); // Truncate long names
                const weight = String(detail.weight.toLocaleString()).padStart(12);
                text += `${code} | ${name} | ${weight}\n`;
            });

            text += "--------------|-----------------------------|--------------\n";
            text += `TOTAL DISTRIBUTED: ${String(data.totalDistributed.toLocaleString()).padStart(45)} Kg\n`;
            text += "=================================================================\n\n";

            // --- Signatures (Simple text placeholder) ---
            text += "                      _________________________              __________________________________\n";
            text += "                      Supplier Signature                     Receiver Signature (Factory/Company)\n";

            return text;
        }

        // --- TXT DOWNLOAD FUNCTION ---
        function downloadChallanTXT() {
            if (!currentChallanData.header.challanNumber) {
                alert("Please generate the Challan first by clicking 'Distribute Final Weight'.");
                return;
            }

            const factoryCopyText = formatChallanToText(currentChallanData, "Factory Copy");
            const supplierCopyText = formatChallanToText(currentChallanData, "Supplier Copy");

            const separator = "\n\n========================= CUT / TEAR HERE =========================\n\n";
            const fullTextContent = factoryCopyText + separator + supplierCopyText;

            const challanNo = currentChallanData.header.challanNumber.replace(/[^\w]/g, '_');
            const filename = `Challan_${challanNo}_${currentChallanData.header.date}.txt`;

            const blob = new Blob([fullTextContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }
    </script>
</body>
</html>